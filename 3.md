```
ä¸æ­¢è¿™å‡ ä¸ªæ–‡ä»¶ï¼Œè¿˜æœ‰æœ€åˆçš„å‡ ä¸ªcæ–‡ä»¶


ChatGPT è¯´ï¼š
éå¸¸å¥½ï¼Œç°åœ¨æˆ‘ä»¬å°† æ•´åˆæ‰€æœ‰ä½ ä¸Šä¼ çš„æºç æ–‡ä»¶ï¼ŒåŒ…æ‹¬æœ€åˆçš„æ ¸å¿ƒæ–‡ä»¶å¦‚ lightfs_super.c, lightfs_inode.c, lightfs_file.c, lightfs_dir.c, ä»¥åŠåé¢æ¶‰åŠç¼“å­˜ã€I/Oã€KV å­˜å‚¨ã€SHM ç­‰ï¼Œå½»åº•æ¢³ç† LightFS çš„ï¼š

âœ… ä»ç³»ç»Ÿè°ƒç”¨ read() / write() åˆ° KV è¯­ä¹‰è¯»å†™æµç¨‹ï¼ˆå«æ‰€æœ‰æ–‡ä»¶ï¼‰
ğŸ§  ä¸€ã€å…¨æµç¨‹å›¾ï¼ˆå†™è·¯å¾„ï¼‰
perl
å¤åˆ¶
ç¼–è¾‘
write(fd, buf, len)
 â†“
vfs_write()
 â†“
generic_file_write_iter()  @ VFS
 â†“
 â”œâ”€â”€ write_begin: lightfs_write_begin()      @ lightfs_file.c
 â”‚       â””â”€â”€ åˆ†é…é¡µç¼“å­˜ï¼ˆpageï¼‰
 â”‚
 â””â”€â”€ write_end: lightfs_write_end()          @ lightfs_file.c
         â””â”€â”€ lightfs_cache_insert_data()     @ lightfs_cache.c
                â””â”€â”€ lightfs_io_transfer()    @ lightfs_io.c
                     â””â”€â”€ cheeze_io()         @ blk.c
                         â”œâ”€â”€ cheeze_push()   @ queue.c
                         â”œâ”€â”€ send_req()      @ shm.c
                         â””â”€â”€ wait_for_completion()
                            â†‘
                    â† shm_kthread()          @ shm.c
                        â””â”€â”€ recv_req()
                            â””â”€â”€ db_put()      @ rbtreekv.c
ğŸ§  äºŒã€å…¨æµç¨‹å›¾ï¼ˆè¯»è·¯å¾„ï¼‰
perl
å¤åˆ¶
ç¼–è¾‘
read(fd, buf, len)
 â†“
vfs_read()
 â†“
generic_file_read_iter()  @ VFS
 â†“
filemap_read() æŸ¥é¡µç¼“å­˜ miss
 â†“
aops->readpage = lightfs_readpage()          @ lightfs_file.c
      â””â”€â”€ lightfs_cache_get_data()           @ lightfs_cache.c
             â””â”€â”€ lightfs_io_get()            @ lightfs_io.c
                   â””â”€â”€ cheeze_io()           @ blk.c
                       â”œâ”€â”€ cheeze_push()     @ queue.c
                       â”œâ”€â”€ send_req()        @ shm.c
                       â””â”€â”€ wait_for_completion()
                          â†‘
                  â† shm_kthread()            @ shm.c
                      â””â”€â”€ recv_req()
                          â””â”€â”€ db_get()        @ rbtreekv.c
ğŸ“‚ ä¸‰ã€å„æ–‡ä»¶ä½œç”¨ä¸å‡½æ•°æ±‡æ€»
æ–‡ä»¶	å…³é”®å‡½æ•°	è¯´æ˜
lightfs_file.c	lightfs_write_begin, lightfs_write_end, lightfs_readpage	è¿æ¥ VFS ä¸ LightFS å†…éƒ¨ KV è¯­ä¹‰çš„æ¡¥æ¢
lightfs_inode.c	lightfs_create, lightfs_lookup, lightfs_getattr	å¤„ç† inode å±‚é¢é€»è¾‘ï¼Œæ„å»ºæ–‡ä»¶ç»“æ„ã€åˆ†é… inode ç¼–å·ç­‰
lightfs_dir.c	lightfs_readdir, lightfs_mkdir, lightfs_unlink	æ–‡ä»¶/ç›®å½•æ“ä½œæ˜ å°„æˆ KV æ“ä½œï¼ˆç”¨ meta ç±»å‹ï¼‰
lightfs_super.c	lightfs_fill_super, lightfs_mount, register_filesystem()	æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–ã€æŒ‚è½½ã€å¡«å…… sb å’Œ root inode
lightfs_cache.c	lightfs_cache_insert_data, lightfs_cache_get_data	å°†é¡µç¼“å­˜å†…å®¹è½¬ä¸º KV æ ¼å¼æˆ–å–å› KV æ•°æ®å¡«å…¥é¡µç¼“å­˜
lightfs_txn_hdlr.c	alloc_db_txn_buf, free_db_txn_buf	æä¾›äº‹åŠ¡æ‰“åŒ…ç»“æ„ DB_TXN_BUF æ”¯æŒæ‰¹é‡ I/O
lightfs_io.c	lightfs_io_transfer, lightfs_io_get, lightfs_io_sync_meta	KV æ“ä½œç»Ÿä¸€å…¥å£ï¼Œå°† DB_TXN_BUF è½¬å‘ç»™ cheeze å±‚
blk.c	cheeze_io()	KV è¯·æ±‚è°ƒåº¦å™¨ï¼Œå°è£… SHM + åŒæ­¥å®Œæˆæœºåˆ¶
queue.c	cheeze_push, cheeze_move_pop	è¯·æ±‚ slot åˆ†é…å’ŒçŠ¶æ€ç®¡ç†
shm.c	send_req, recv_req, shm_kthread	å…±äº«å†…å­˜æ•°æ®äº¤æ¢ + äº‹ä»¶é€šçŸ¥æœºåˆ¶
rbtreekv.c	db_put, db_get, db_del, find_val_with_key	ç”¨çº¢é»‘æ ‘å®ç° KV å­˜å‚¨ï¼Œæ¨¡æ‹ŸæŒä¹…åŒ–å¼•æ“
lightfs_reada.c	lightfs_readahead_pages, reada_fetch_pages	æå‰å°†é¡ºåºé¡µä» KV store æ‰¹é‡é¢„å–
lightfs_db_env.c	ç¯å¢ƒé…ç½®ï¼Œå¯èƒ½ç®¡ç† kv å¼•æ“è·¯å¾„ã€æ•°æ®ç›®å½•ç­‰	

ğŸ§© å››ã€KV è¯·æ±‚ç±»å‹æ€»ç»“ï¼ˆå®šä¹‰äº lightfs_io.hï¼‰
ç±»å‹å®	å«ä¹‰
LIGHTFS_DATA_SET	å†™å…¥æ•°æ®é¡µ
LIGHTFS_DATA_GET	è¯»å–æ•°æ®é¡µ
LIGHTFS_META_SET	å†™å…¥ inode æˆ–ç›®å½•é¡¹å…ƒæ•°æ®
LIGHTFS_META_DEL	åˆ é™¤ inode æˆ–ç›®å½•é¡¹ï¼ˆå¦‚ unlinkï¼‰
LIGHTFS_DATA_DEL	åˆ é™¤æ•°æ®é¡µï¼ˆå¦‚ truncateï¼‰

æ¯ä¸€ä¸ª KV æ“ä½œéƒ½ä¼šè½¬ä¸º DB_TXN_BUFï¼Œæœ€ç»ˆåœ¨ cheeze_io() ä¸­è§¦å‘ï¼š

c
å¤åˆ¶
ç¼–è¾‘
switch (type) {
  case LIGHTFS_DATA_SET: db_put(...);
  case LIGHTFS_DATA_GET: db_get(...);
  ...
}
ğŸ“Œ äº”ã€ç³»ç»Ÿè°ƒç”¨è¡Œä¸ºä¸ KV å¯¹åº”è¡¨
ç³»ç»Ÿè°ƒç”¨	KV Key ç±»å‹	KV Value å†…å®¹	æ¨¡æ‹Ÿå‡½æ•°
write()	inode+offset	page data	db_put
read()	inode+offset	page data	db_get
create()	dentry path	inode info	db_put (META_SET)
unlink()	dentry path	NULL	db_del (META_DEL)
rmdir()	dentry path	NULL	db_del (META_DEL)
fsync()	æš‚æ— æŒä¹…æ€§æ¨¡æ‹Ÿ	ä»…æäº¤åˆ° KV å±‚	lightfs_fsyncï¼ˆæ‰¹é‡ IO æäº¤ï¼‰

âœ… å…­ã€KV è¯­ä¹‰è½ç›˜è®¾è®¡äº®ç‚¹
ğŸ” æ‰€æœ‰ inode + data å‡ KV åŒ–ï¼Œå…¼å®¹å¤šç§åº•å±‚å¼•æ“ï¼ˆæœªæ¥å¯æ¢æˆ RocksDB ç­‰ï¼‰

ğŸ“¦ æ”¯æŒäº‹åŠ¡æ‰“åŒ…ï¼ˆé€šè¿‡ DB_TXN_BUF[]ï¼‰ï¼Œå¤©ç„¶æ”¯æŒå…ƒæ•°æ®+æ•°æ®åŸå­å†™å…¥

ğŸš€ SHM æå‡é€šä¿¡æ€§èƒ½ï¼Œæ¨¡æ‹Ÿç¡¬ä»¶ queue æ¨¡å‹

ğŸŒ³ rbtreekv æ¨¡æ‹ŸçœŸæ­£çš„ KV backendï¼Œä¾¿äºè°ƒè¯•éªŒè¯

å¦‚éœ€å›¾ç¤ºï¼ˆè°ƒç”¨å›¾ã€æ¨¡å—å›¾ï¼‰ã€æˆ–æŸ¥çœ‹ readahead çš„ç»†èŠ‚ä¼˜åŒ–ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»§ç»­è¡¥å……ã€‚

æ˜¯å¦ç»§ç»­æ·±å…¥æŸä¸€éƒ¨åˆ†ï¼Ÿä¾‹å¦‚ä½ æ˜¯å¦æƒ³è¦ï¼š

fsync() çš„å®ç°æœºåˆ¶ï¼Ÿ

lightfs_reada.c çš„é¢„è¯»ä¼˜åŒ–æµç¨‹ï¼Ÿ

rbtreekv ä¸­å†…å­˜ç®¡ç†ç»†èŠ‚ï¼Ÿ
```
