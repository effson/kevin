```
ä»ç³»ç»Ÿè°ƒç”¨read writeå‡½æ•°åˆ°ç»KVå¤„ç†è½ç›˜å’Œè¯»ç›˜ï¼Œç»“åˆä¸Šé¢æåˆ°çš„æ‰€æœ‰çš„ä»£ç æ–‡ä»¶ï¼Œå°†æµç¨‹å†æ¢³ç†ä¸€ä¸‹


ChatGPT è¯´ï¼š
å¥½çš„ï¼Œæˆ‘ä»¬ç°åœ¨æ¥ å…¨é¢æ¢³ç† LightFS ä» read() / write() ç³»ç»Ÿè°ƒç”¨åˆ° KV è¯­ä¹‰å¤„ç†çš„å…¨è¿‡ç¨‹ï¼Œç»“åˆä½ æä¾›çš„æ‰€æœ‰æ¨¡å—ï¼ŒåŒ…æ‹¬ï¼š

ğŸ§© VFS æ¥å£å±‚ï¼ˆå¦‚ file_operations / address_space_operationsï¼‰

ğŸ“¥ æ•°æ®é¡µç®¡ç†ï¼ˆé¡µç¼“å­˜ã€äº‹åŠ¡ï¼‰

ğŸ” KV è¯·æ±‚å°è£…ï¼ˆlightfs_io.c, lightfs_cache.cï¼‰

ğŸ§  KV é€šä¿¡æœºåˆ¶ï¼ˆcheeze_io(), shm.c, queue.cï¼‰

ğŸŒ³ åº•å±‚ KV å¼•æ“ï¼ˆrbtreekv.cï¼‰

ğŸ§  ä¸€å›¾æ€»è§ˆï¼šread & write å®Œæ•´è°ƒç”¨è·¯å¾„æ€»å›¾
perl
å¤åˆ¶
ç¼–è¾‘
ç”¨æˆ·ç©ºé—´è°ƒç”¨
 â”œâ”€â”€ write(fd, buf, len)
 â”‚     â†“
 â”‚   generic_file_write_iter
 â”‚     â†“
 â”‚   lightfs_write_begin / lightfs_write_end
 â”‚     â†“
 â”‚   lightfs_cache_insert_data()
 â”‚     â†“
 â”‚   lightfs_io_transfer()
 â”‚     â†“
 â”‚   cheeze_io() â†’ send_req() â†’ SHM
 â”‚     â†“
 â”‚   shm_kthread() â†’ recv_req()
 â”‚     â†“
 â”‚   db_put() / db_update() @ rbtreekv.c
 â”‚
 â””â”€â”€ read(fd, buf, len)
       â†“
     generic_file_read_iter
       â†“
     filemap_read() â†’ miss â†’ readpage
       â†“
     lightfs_readpage()
       â†“
     lightfs_cache_get_data()
       â†“
     lightfs_io_get()
       â†“
     cheeze_io() â†’ send_req() â†’ SHM
       â†“
     shm_kthread() â†’ recv_req()
       â†“
     db_get() @ rbtreekv.c
       â†“
     æ‹·è´åˆ° page->data â†’ VFS å®Œæˆ read
ğŸ“‚ äºŒã€write è°ƒç”¨é“¾è¯¦ç»†å‰–æï¼ˆè½ç›˜ï¼‰
âœ… ä» syscall å¼€å§‹
c
å¤åˆ¶
ç¼–è¾‘
// ç”¨æˆ·ç©ºé—´
write(fd, buf, len)
â¬‡ï¸ è¿›å…¥ VFS
c
å¤åˆ¶
ç¼–è¾‘
vfs_write()
 â””â”€â†’ file->f_op->write_iter = generic_file_write_iter
â¬‡ï¸ generic write ä¸­ï¼š
c
å¤åˆ¶
ç¼–è¾‘
generic_file_write_iter()
 â””â”€â†’ generic_perform_write()
     â”œâ”€â†’ aops->write_begin = lightfs_write_begin()
     â”œâ”€â†’ page cache + copy_from_iter()
     â””â”€â†’ aops->write_end = lightfs_write_end()
â¬‡ï¸ LightFS å†…éƒ¨è½¬åŒ–ä¸º KV
c
å¤åˆ¶
ç¼–è¾‘
lightfs_write_end()
 â””â”€â†’ lightfs_cache_insert_data()
     â””â”€â†’ æ„é€  txn_bufï¼ˆå« key/inode/pageï¼‰
     â””â”€â†’ è°ƒç”¨ lightfs_io_transfer()
         â””â”€â†’ cheeze_io()
ğŸ§  cheeze_io()ï¼š
c
å¤åˆ¶
ç¼–è¾‘
cheeze_io()
 â”œâ”€â†’ cheeze_push() â†’ åˆ†é…é˜Ÿåˆ— slot
 â”œâ”€â†’ send_req()
 â”‚    â””â”€â†’ å†™å…±äº«å†…å­˜ï¼ˆshm.cï¼‰
 â”‚    â””â”€â†’ send_event[id] = 1
 â””â”€â†’ wait_for_completion(&req->acked)
ğŸ§  shm_kthread()ï¼ˆåå°çº¿ç¨‹ï¼‰
c
å¤åˆ¶
ç¼–è¾‘
shm_kthread()
 â””â”€â†’ æ£€æŸ¥ recv_event[i] == 1
     â””â”€â†’ recv_req()
         â””â”€â†’ complete(&req->acked)
         â””â”€â†’ è°ƒç”¨ db_put()/db_update()
ğŸ§  rbtreekv.cï¼šKV å­˜å‚¨çœŸæ­£è½åœ°
c
å¤åˆ¶
ç¼–è¾‘
db_put()
 â””â”€â†’ æ ¹æ® key æŸ¥æ‰¾çº¢é»‘æ ‘èŠ‚ç‚¹
 â”œâ”€â†’ å¦‚æœå­˜åœ¨ â†’ è¦†ç›–
 â””â”€â†’ å¦‚æœä¸å­˜åœ¨ â†’ æ–°å»ºå¹¶æ’å…¥
æœ€ç»ˆæ¨¡æ‹Ÿè½ç›˜å®Œæˆã€‚

ğŸ“‚ ä¸‰ã€read è°ƒç”¨é“¾è¯¦ç»†å‰–æï¼ˆè¯»ç›˜ï¼‰
âœ… ä» syscall å¼€å§‹
c
å¤åˆ¶
ç¼–è¾‘
read(fd, buf, len)
â¬‡ï¸ è¿›å…¥ VFS
c
å¤åˆ¶
ç¼–è¾‘
vfs_read()
 â””â”€â†’ file->f_op->read_iter = generic_file_read_iter
â¬‡ï¸ generic read ä¸­ï¼š
c
å¤åˆ¶
ç¼–è¾‘
generic_file_read_iter()
 â””â”€â†’ filemap_read()
     â”œâ”€â†’ find_get_page()
     â””â”€â†’ miss â†’ aops->readpage = lightfs_readpage()
â¬‡ï¸ LightFS read page
c
å¤åˆ¶
ç¼–è¾‘
lightfs_readpage()
 â””â”€â†’ lightfs_cache_get_data()
     â””â”€â†’ æ„é€  txn_bufï¼ˆkey = inode + offsetï¼‰
     â””â”€â†’ lightfs_io_get()
         â””â”€â†’ cheeze_io()ï¼ˆå‘é€ GET è¯·æ±‚ï¼‰
â¬‡ï¸ cheeze_io â†’ shm â†’ db_get()
c
å¤åˆ¶
ç¼–è¾‘
cheese_io()
 â”œâ”€â†’ cheeze_push()
 â”œâ”€â†’ send_req() â†’ å†™ SHM buffer
 â”œâ”€â†’ è®¾ç½® send_event
 â””â”€â†’ wait_for_completion()

shm_kthread() â†’ recv_event == 1
 â””â”€â†’ recv_req()
     â””â”€â†’ db_get() from rbtreekv.c
         â””â”€â†’ æ‹·è´ page æ•°æ®
         â””â”€â†’ complete(&req->acked)
â¬‡ï¸ LightFS å›å¡« page cache
c
å¤åˆ¶
ç¼–è¾‘
lightfs_cache_get_data() è¿”å›
lightfs_readpage() ä¸­ï¼š
 â””â”€â†’ SetPageUptodate(page);
 â””â”€â†’ unlock_page(page);
ğŸ§© å››ã€KV ç»“æ„è¯´æ˜
ç±»å‹	æ„é€ æ–¹å¼	è¯´æ˜
key	inode_num + block_offset	4B + 4B ç»„åˆ
value	é¡µç¼“å­˜æ•°æ®ï¼ˆ4KBï¼‰	é€šè¿‡ pageâ†’data æŒ‡é’ˆä¼ é€’
txn_buf	lightfs_io_transfer()/_get()/_put() çš„å°è£…è½½ä½“	åŒ…å« key/value/type

âœ… äº”ã€ä½ ä¸Šä¼ æ¨¡å—çš„èŒè´£æ€»ç»“
æ–‡ä»¶	ä½œç”¨
lightfs_io.c/.h	å‘èµ· KV IO è¯·æ±‚ï¼Œæ ¸å¿ƒè½¬æ¢æ¥å£
lightfs_cache.c/.h	æ•°æ®ç¼“å­˜ã€äº‹åŠ¡è®°å½•ã€æ¥å£å°è£…
lightfs_txn_hdlr.c/.h	æ‰¹é‡äº‹åŠ¡ç»“æ„æ„å»ºä¸å°è£…
cheeze.h	è¯·æ±‚ç»“æ„ã€æ¥å£å®šä¹‰
blk.c	å®ç° cheeze_io() é€»è¾‘
shm.c	SHM è¯·æ±‚/åº”ç­”é€šé“ï¼ˆsend/recvï¼‰
queue.c	è¯·æ±‚é˜Ÿåˆ—ç®¡ç†ï¼ˆtag åˆ†é…ã€å®Œæˆå›æ”¶ï¼‰
rbtreekv.c/.h	çº¢é»‘æ ‘æ¨¡æ‹Ÿ KV å­˜å‚¨å¼•æ“ï¼Œå®ç° db_get/put/update

âœ… æ€»ç»“é‡ç‚¹
é˜¶æ®µ	æè¿°
VFS â†’ Page Cache	å°†ç³»ç»Ÿè°ƒç”¨è½¬åŒ–ä¸ºé¡µç²’åº¦çš„è¯»å†™è¯·æ±‚
LightFS Write Path	å°è£…æˆ KV çš„ put è¯·æ±‚ï¼ˆkey=inode+offsetï¼‰
LightFS Read Path	å°è£…æˆ KV çš„ get è¯·æ±‚ï¼ˆè¯»å– pageï¼‰
KV å±‚å¤„ç†	cheeze_io å‘é€è¯·æ±‚ â†’ SHM â†’ åå°çº¿ç¨‹ â†’ rbtreekv
æ¨¡æ‹ŸæŒä¹…åŒ–	çº¢é»‘æ ‘æ¨¡æ‹Ÿæ•°æ®å—å­˜å‚¨ï¼Œå¹¶æ”¯æŒè¦†ç›–ã€åˆ é™¤ç­‰æ“ä½œ


```
